#!/usr/bin/env bash
set -e

THEMES_FILE="$HOME/.config/themes.json"
SOCKET="$HOME/.cache/qtile/qtilesocket.:0"

# Terminal & editor (Qtile usually sets TERMINAL)
TERMINAL="${TERMINAL:-alacritty}"
EDITOR_CMD="${EDITOR:-vim}"

# Default theme selection method
theme_selector="none"

# ---------------------------
# Parse command-line options
# ---------------------------
while getopts "dr" opt; do
    case $opt in
        d) theme_selector="dmenu" ;;
        r) theme_selector="rofi" ;;
        *)
            echo "Usage: $0 [-d] [-r]"
            exit 1
            ;;
    esac
done

if [[ "$theme_selector" == "none" ]]; then
    echo "Error: You must choose -d (dmenu) or -r (rofi)"
    exit 1
fi

# ---------------------------
# Load themes dynamically
# ---------------------------
themes=($(jq -r '.themes | keys[]' "$THEMES_FILE" | sort))

# ---------------------------
# Menu helpers
# ---------------------------
menu() {
    local prompt="$1"
    shift
    printf "%s\n" "$@" | case "$theme_selector" in
        dmenu) dmenu -p "$prompt" -l 10 ;;
        rofi)  rofi -dmenu -p "$prompt" -i ;;
    esac
}

# ---------------------------
# Actions
# ---------------------------
choose_theme() {
    local selected
    selected=$(menu "Select Theme:" "${themes[@]}")

    if [[ -n "$selected" ]]; then
        jq --arg theme "$selected" '.current = $theme' \
            "$THEMES_FILE" > "$THEMES_FILE.tmp" && mv "$THEMES_FILE.tmp" "$THEMES_FILE"
        apply_theme
    fi
}

edit_themes() {
    if [[ -t 1 ]]; then
        "$EDITOR_CMD" "$THEMES_FILE"
    else
        "$TERMINAL" -e "$EDITOR_CMD" "$THEMES_FILE" &
    fi
}

apply_theme() {
    local current
    current=$(jq -r '.current' "$THEMES_FILE")
    echo "Applying theme: $current"

    bash update-ohmyposh.sh
    bash update-rofi-theme.sh
    bash update_dmenu_theme.sh
    bash update-alacritty-theme.sh
    bash update-dunst-theme.sh
    bash update-gtk2-theme.sh
    bash update-gtk3-theme.sh
    bash update-gtk4-theme.sh
    bash update_picom_theme.sh

    restart_qtile
}

restart_qtile() {
    echo "Restarting Qtile..."
    qtile cmd-obj -o cmd -f restart || true

    for i in {1..50}; do
        if qtile cmd-obj -s "$SOCKET" -o cmd -f info >/dev/null 2>&1; then
            echo "Qtile restarted successfully."
            return
        fi
        sleep 0.2
    done

    echo "⚠️  Qtile restart timed out or IPC not ready."
}

# ---------------------------
# Main menu
# ---------------------------
action=$(menu "Theme Manager:" \
    "Choose a theme" \
    "Edit themes.json" \
    "Apply theme"
)

case "$action" in
    "Choose a theme")   choose_theme ;;
    "Edit themes.json") edit_themes ;;
    "Apply theme")     apply_theme ;;
    *) exit 0 ;;
esac

